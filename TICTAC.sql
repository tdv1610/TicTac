CREATE TABLE AD (
    EMAILAD VARCHAR2(50),
	TENAD NVARCHAR2(50),
	MATKHAU VARCHAR2(50)
);

----------------------------------------------------------------
CREATE TABLE NGUOIDUNG (
    EMAILND VARCHAR2(50),
    TENND NVARCHAR2(50),
    MATKHAU VARCHAR2(30)
);

---------------------------------------------------------------
CREATE TABLE NGUOIDUNG_NHOM(
    EMAILND VARCHAR2(50),
    MANHOM VARCHAR2(30)
);

---------------------------------------------------------------
CREATE TABLE NHOM(
    MANHOM VARCHAR2(30),
    TENNHOM NVARCHAR2(50),
    EMAIL_TRUONGNHOM VARCHAR2(50)
    
);

---------------------------------------------------------------
CREATE TABLE CONGVIEC (
    MACV VARCHAR2(30),
    MANHOM VARCHAR2(30),
    TENCV NVARCHAR2(50),
    LINHVUC NVARCHAR2(60),
    MOTACV CLOB,
    MUC_UUTIEN INT,
    NGAYBD DATE,
    NGAYKT DATE
);

---------------------------------------------------------------
CREATE TABLE THUCHIEN (
    EMAIL_TV VARCHAR2(50),
    MACV_PC VARCHAR2(30),
    MANHOM VARCHAR2(30),
    TRANGTHAI VARCHAR2(30)
);


CREATE TABLE FILE_ATTACHMENT (
    MAFILE VARCHAR2(20),
    TENFILE VARCHAR2(255),
    LOAIFILE VARCHAR2(100),
    KICHTHUOC NUMBER,
    DUONGDAN VARCHAR2(255),
    MA_CV VARCHAR2(30)
);

CREATE TABLE MESSAGES (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    SENDER_EMAIL VARCHAR2(255),
    RECEIVER_EMAIL VARCHAR2(255),
    MESSAGE_TEXT VARCHAR2(4000),
    TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ID)
);

CREATE TABLE THONGBAO(
    THONG_BAO NVARCHAR2(500),
    PRIMARY KEY (THONG_BAO)
)

CREATE TABLE THONGBAOTINNHAN (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY, 
    senderEmail VARCHAR(255),
    receiverEmail VARCHAR(255),
    message VARCHAR(255),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    isRead NUMBER(1) DEFAULT 0
);

----------------------------------------------------------------
grant unlimited tablespace to c##tictac;
REM INSERTING into AD
SET DEFINE OFF;
INSERT INTO AD VALUES ('22521438@gm.uit.edu.vn', 'Huỳnh Anh Thư', '1234athu');
INSERT INTO AD VALUES ('22521455@gm.uit.edu.vn', 'Hoàng Dương Ngọc Thủy', '2252thuy');
INSERT INTO AD VALUES ('khanhphuong06@gmail.com', 'Trần Khánh Phương', '062004');
INSERT INTO AD VALUES ('quocanhle@gmail.com', 'Lê Nguyên Quốc Anh', 'anhle2222');
INSERT INTO AD VALUES ('ngocanhnguyen@gmail.com', 'Nguyễn Lê Ngọc Anh', 'ahihihi');

REM INSERTING into NGUOIDUNG
SET DEFINE OFF;
INSERT INTO NGUOIDUNG VALUES ('22521366@gm.uit.edu.vn', 'Thanh Trần', '1366thanh');
INSERT INTO NGUOIDUNG VALUES ('phongle@gmail.com', 'Lê Thanh Phong', '246810phong');
INSERT INTO NGUOIDUNG VALUES ('baonhanxyz@gmail.com', 'Nhân Lê', 'abcd1234');
INSERT INTO NGUOIDUNG VALUES ('thuytrang004@gmail.com', 'Trang', 'tttranggg');

REM INSERTING into NHOM
SET DEFINE OFF;
INSERT INTO NHOM VALUES ('1', 'Chạy đồ án sml', '22521366@gm.uit.edu.vn');
INSERT INTO NHOM VALUES ('2', 'Ôn thi sml', 'thuytrang004@gmail.com');

REM INSERTING into NGUOIDUNG_NHOM
SET DEFINE OFF;
INSERT INTO NGUOIDUNG_NHOM VALUES ('22521366@gm.uit.edu.vn','1');
INSERT INTO NGUOIDUNG_NHOM VALUES ('phongle@gmail.com', '1');
INSERT INTO NGUOIDUNG_NHOM VALUES ('baonhanxyz@gmail.com', '2');
INSERT INTO NGUOIDUNG_NHOM VALUES ('thuytrang004@gmail.com','2');

REM INSERTING into CONGVIEC
ALTER SESSION SET NLS_DATE_FORMAT = 'DD-MM-YY';
SET DEFINE OFF;
INSERT INTO CONGVIEC VALUES ('1', '1', 'Tạo giao diện dồ án', 'CNTT', 'Tạo bảng Java Swing', 1, '30-05-24', '31-05-24');
INSERT INTO CONGVIEC VALUES ('2', '1', 'Tạo database', 'CNTT', 'Tạo trong Oracle', 1, '25-05-24', '26-05-24');
INSERT INTO CONGVIEC VALUES ('3', '1', 'Học SD Github', 'CNTT', 'Tự tìm kiếm nguồn học', 3, '27-05-24', '28-05-24');
INSERT INTO CONGVIEC VALUES ('4', '2', 'Ôn thi CK HDH', 'CNTT', 'Tìm tài liệu ôn', 2, '28-05-24', '29-06-24');
INSERT INTO CONGVIEC VALUES ('5', '2', 'Lấy gốc HQTCSDL', 'CSDL', 'Tìm bài giảng', 2, '24-05-24', '25-06-24');
INSERT INTO CONGVIEC VALUES ('6', '1', 'Tạo giao diện', 'CNTT', 'Java Swing', 1, '27-05-24', '28-05-24');


REM INSERTING into THUCHIEN
SET DEFINE OFF;
INSERT INTO THUCHIEN VALUES ('22521366@gm.uit.edu.vn', '1','1', 'Đã hoàn thành');
INSERT INTO THUCHIEN VALUES ('22521366@gm.uit.edu.vn', '2','1', 'Cần làm');
INSERT INTO THUCHIEN VALUES ('phongle@gmail.com', '3','1' ,'Cần làm');
INSERT INTO THUCHIEN VALUES ('baonhanxyz@gmail.com', '4','2', 'Cần làm');
INSERT INTO THUCHIEN VALUES ('thuytrang004@gmail.com', '5','2', 'Đang làm');
INSERT INTO THUCHIEN VALUES ('thuytrang004@gmail.com', '6','2', 'Đang làm');
--------------------------------------------------------------------------------
--  Constraints for Table AD
--------------------------------------------------------

  ALTER TABLE "AD" ADD CONSTRAINT "PK_AD" PRIMARY KEY ("EMAILAD")
  USING INDEX  ENABLE;
  ALTER TABLE "AD" MODIFY ("EMAILAD" NOT NULL ENABLE);
  ALTER TABLE "AD" MODIFY ("TENAD" NOT NULL ENABLE);
  ALTER TABLE "AD" MODIFY ("MATKHAU" NOT NULL ENABLE);


--------------------------------------------------------------------------------
--  Constraints for Table NGUOIDUNG
--------------------------------------------------------
    ALTER TABLE "NGUOIDUNG"
  ADD CONSTRAINT "PK_NGUOIDUNG" PRIMARY KEY ("EMAILND")
  USING INDEX ENABLE;
  ALTER TABLE "NGUOIDUNG" MODIFY ("EMAILND" NOT NULL ENABLE);
  ALTER TABLE "NGUOIDUNG" MODIFY ("TENND" NOT NULL ENABLE);
  ALTER TABLE "NGUOIDUNG" MODIFY ("MATKHAU" NOT NULL ENABLE);  
  
--------------------------------------------------------
--  Constraints for Table NHOM
--------------------------------------------------------

  ALTER TABLE "NHOM" ADD CONSTRAINT "PK_NHOM_NEW" PRIMARY KEY ("MANHOM") USING INDEX;
  ALTER TABLE "NHOM" MODIFY ("MANHOM" NOT NULL ENABLE);
  ALTER TABLE "NHOM" MODIFY ("TENNHOM" NOT NULL ENABLE);
  ALTER TABLE "NHOM" MODIFY ("EMAIL_TRUONGNHOM" NOT NULL ENABLE);
  ALTER TABLE "NHOM" ADD CONSTRAINT "FK_TRUONGNHOM" FOREIGN KEY ("EMAIL_TRUONGNHOM")
	  REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;     
      
----------------------------------------------------------
--  Constraints for Table NGUOIDUNG_NHOM
--------------------------------------------------------

  ALTER TABLE "NGUOIDUNG_NHOM" ADD CONSTRAINT "PK_NHOM" PRIMARY KEY ("EMAILND","MANHOM")
  USING INDEX  ENABLE;
    ALTER TABLE "NGUOIDUNG_NHOM" MODIFY ("EMAILND" NOT NULL ENABLE);
  ALTER TABLE "NGUOIDUNG_NHOM" MODIFY ("MANHOM" NOT NULL ENABLE);
  ALTER TABLE "NGUOIDUNG_NHOM" ADD CONSTRAINT "FK_NDTHUOCNHOM" FOREIGN KEY ("EMAILND")
	  REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;
  ALTER TABLE "NGUOIDUNG_NHOM" ADD CONSTRAINT "FK_THUOCNHOM" FOREIGN KEY ("MANHOM")
	  REFERENCES "NHOM" ("MANHOM") ENABLE;

--------------------------------------------------------
--  Constraints for Table CONGVIEC
--------------------------------------------------------

  ALTER TABLE "CONGVIEC" ADD CONSTRAINT "PK_CONGVIEC" PRIMARY KEY ("MACV")
  USING INDEX  ENABLE;
  ALTER TABLE "CONGVIEC" MODIFY ("MACV" NOT NULL ENABLE);
  ALTER TABLE "CONGVIEC" MODIFY ("MANHOM" NOT NULL ENABLE);
  ALTER TABLE "CONGVIEC" MODIFY ("TENCV" NOT NULL ENABLE);
   ALTER TABLE "CONGVIEC" ADD CONSTRAINT "FK_CVTHUOCNHOM" FOREIGN KEY ("MANHOM")
	  REFERENCES "NHOM" ("MANHOM") ENABLE;
--------------------------------------------------------
--  Constraints for Table THUCHIEN
--------------------------------------------------------

  ALTER TABLE "THUCHIEN" ADD CONSTRAINT "PK_THUCHIEN" PRIMARY KEY ("EMAIL_TV", "MACV_PC", "MANHOM")
  USING INDEX  ENABLE;
  ALTER TABLE "THUCHIEN" MODIFY ("EMAIL_TV" NOT NULL ENABLE);
  ALTER TABLE "THUCHIEN" MODIFY ("MACV_PC" NOT NULL ENABLE);
  ALTER TABLE "THUCHIEN" MODIFY ("MANHOM" NOT NULL ENABLE);
  ALTER TABLE "THUCHIEN" MODIFY ("TRANGTHAI" NOT NULL ENABLE);
  ALTER TABLE "THUCHIEN" ADD CONSTRAINT "FK_TV_DC_PC" FOREIGN KEY ("EMAIL_TV")
	  REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;
  ALTER TABLE "THUCHIEN" ADD CONSTRAINT "FK_CVPC" FOREIGN KEY ("MACV_PC")
	  REFERENCES "CONGVIEC" ("MACV") ENABLE;
---------------------------------------------------------------------------------------------------
--  Constraints for Table PK_FILEATTACHMENTS
---------------------------------------------------------------------------------------------------
  ALTER TABLE "FILE_ATTACHMENT" ADD CONSTRAINT "PK_FILEATTACHMENTS" PRIMARY KEY ("MAFILE")
  USING INDEX  ENABLE;
  ALTER TABLE "FILE_ATTACHMENT" MODIFY ("MA_CV" NOT NULL ENABLE);
  ALTER TABLE "FILE_ATTACHMENT" MODIFY ("TENFILE" NOT NULL ENABLE);
  ALTER TABLE "FILE_ATTACHMENT" MODIFY ("DUONGDAN" NOT NULL ENABLE);
  ALTER TABLE "FILE_ATTACHMENT" MODIFY ("KICHTHUOC" NOT NULL ENABLE);
  ALTER TABLE "FILE_ATTACHMENT" ADD CONSTRAINT "FK_CongViecID" FOREIGN KEY ("MA_CV")
    REFERENCES "CONGVIEC" ("MACV") ON DELETE CASCADE ENABLE;

---------------------------------------------------------------------------------------------------
--  Constraints for Table MESSAGES
---------------------------------------------------------------------------------------------------
  ALTER TABLE "MESSAGES" ADD CONSTRAINT "PK_MESSAGES" PRIMARY KEY ("ID") 
  USING INDEX ENABLE;
  ALTER TABLE "MESSAGES" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "MESSAGES" MODIFY ("SENDER_EMAIL" NOT NULL ENABLE);
  ALTER TABLE "MESSAGES" MODIFY ("RECEIVER_EMAIL" NOT NULL ENABLE);
  ALTER TABLE "MESSAGES"ADD CONSTRAINT "FK_MESSAGES_SENDER" FOREIGN KEY ("SENDER_EMAIL")
     REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;
  ALTER TABLE "MESSAGES"  ADD CONSTRAINT "FK_MESSAGES_RECEIVER" FOREIGN KEY ("RECEIVER_EMAIL")
     REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;


---------------------------------------------------------------------------------------------------
--  Constraints for Table THONGBAOTINNHAN
---------------------------------------------------------------------------------------------------
  ALTER TABLE "THONGBAOTINNHAN" ADD CONSTRAINT "PK_THONGBAOTINNHAN" PRIMARY KEY ("ID") 
  USING INDEX ENABLE;
  ALTER TABLE "THONGBAOTINNHAN" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "THONGBAOTINNHAN" MODIFY ("SENDER_EMAIL" NOT NULL ENABLE);
  ALTER TABLE "THONGBAOTINNHAN" MODIFY ("RECEIVER_EMAIL" NOT NULL ENABLE);
  ALTER TABLE "THONGBAOTINNHAN" ADD CONSTRAINT "FK_THONGBAOTINNHAN_SENDER" FOREIGN KEY ("SENDER_EMAIL")
      REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;
  ALTER TABLE "THONGBAOTINNHAN" ADD CONSTRAINT "FK_THONGBAOTINNHAN_RECEIVER" FOREIGN KEY ("RECEIVER_EMAIL")
      REFERENCES "NGUOIDUNG" ("EMAILND") ENABLE;

-----------------------------------------------------------------------------------------------------
--TRIGGER
--CHECK_NGAYBD_CONGVIEC
CREATE OR REPLACE TRIGGER TRIGGER_CHECK_NGAYBD
BEFORE INSERT OR UPDATE ON CONGVIEC
FOR EACH ROW
BEGIN
    IF (:NEW.NGAYBD <= CURRENT_DATE) THEN
        raise_application_error(-20001, 'Thoi gian bat dau khong the nho hon thoi gian hien tai');
    END IF;
END;

----------------------------------------------------------------------------------------------------
--CHECK_NGAYKT_CONGVIEC
CREATE OR REPLACE TRIGGER TRIGGER_CHECK_NGAYKT
BEFORE INSERT OR UPDATE ON CONGVIEC
FOR EACH ROW
BEGIN
    IF (:NEW.NGAYKT <= :NEW.NGAYBD) THEN
        raise_application_error(-20001, 'Thoi gian ket thuc khong the nho hon hoac bang thoi gian bat dau cong viec');
    END IF;
END;

--------------------------------------------------------------------------------------------
-- GÁN MAFLE TỰ ĐỘNG
CREATE SEQUENCE MAFILE_SEQ START WITH 1 INCREMENT BY 1;
--SET MA FILE T? ??NG
CREATE OR REPLACE TRIGGER FILE_ATTACHMENT_TRIGGER
BEFORE INSERT ON FILE_ATTACHMENT
FOR EACH ROW
BEGIN
    IF :NEW.MAFILE IS NULL THEN
        SELECT MAFILE_SEQ.NEXTVAL INTO :NEW.MAFILE FROM DUAL;
    END IF;
END;
/


----------------------------------------------------------------------------------------------------
-- PROCEDURE
-- THEM NGUOI DUNG
CREATE OR REPLACE PROCEDURE THEM_NGUOIDUNG (
    I_EMAIL IN NGUOIDUNG.EMAILND%TYPE, 
    I_TENUSER IN NGUOIDUNG.TENND%TYPE, 
    I_MATKHAU IN NGUOIDUNG.MATKHAU%TYPE
)
IS
BEGIN
    INSERT INTO NGUOIDUNG (EMAILND, TENND, MATKHAU) 
    VALUES (I_EMAIL, I_TENUSER, I_MATKHAU);
    DBMS_OUTPUT.PUT_LINE('Them user thanh cong');
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('Email da ton tai');
END;

set serveroutput on;
execute THEM_NGUOIDUNG('thuytrang004@gmail.com', 'Thùy Trang', '12345');

-----------------------------------------------------------------------------------------------------
-- CAP NHAT NGUOI DUNG
create or replace PROCEDURE CAPNHAT_NGUOIDUNG (
    I_EMAIL IN NGUOIDUNG.EMAILND%TYPE, 
    I_TENND IN NGUOIDUNG.TENND%TYPE, 
    I_MATKHAU IN NGUOIDUNG.MATKHAU%TYPE
)
IS
    L_EMAIL NGUOIDUNG.EMAILND%TYPE;
BEGIN
    SELECT EMAILND INTO L_EMAIL
    FROM NGUOIDUNG
    WHERE EMAILND = I_EMAIL;
    IF L_EMAIL IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('Ng??i dùng không t?n t?i');
    ELSE
        UPDATE NGUOIDUNG
        SET TENND = I_TENND, MATKHAU = I_MATKHAU
        WHERE EMAILND = I_EMAIL;
        DBMS_OUTPUT.PUT_LINE('Cap nhat user thanh cong');
    END IF;
    EXCEPTION WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Ng??i dùng không t?n t?i');
END;

set serveroutput on;
execute CAPNHAT_NGUOIDUNG('22521366@gm.uit.edu.vn', 'Thanh Tr?n','1366thanh');

---------------------------------------------------------------------------------------------------------
--XOA NGUOI DUNG
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE XOA_NGUOIDUNG (
    I_EMAIL IN NGUOIDUNG.EMAILND%TYPE
)
IS
    L_EMAIL NGUOIDUNG.EMAILND%TYPE;
BEGIN
    SELECT EMAILND INTO L_EMAIL
    FROM NGUOIDUNG
    WHERE EMAILND = I_EMAIL;
    
    IF L_EMAIL IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('EMAILND không tồn tại');
    ELSE    
    -- xóa người dùng khỏi bảng thực hiện
        DELETE FROM THUCHIEN
        WHERE EMAIL_TV = I_EMAIL;

    -- xóa người dùng từ bảng thực hiện nếu là trưởng nhóm
        DELETE FROM THUCHIEN
        WHERE MANHOM IN (SELECT MANHOM FROM NHOM WHERE EMAIL_TRUONGNHOM = I_EMAIL);

    -- xóa nhóm khỏi bảng công việc nếu người dùng là trongwr nhóm
        DELETE FROM CONGVIEC
        WHERE MANHOM IN (SELECT MANHOM FROM NHOM WHERE EMAIL_TRUONGNHOM = I_EMAIL);

    -- xóa người dùng khỏi bảng NGUOIDUNG_NHOM
        DELETE FROM NGUOIDUNG_NHOM
        WHERE EMAILND = I_EMAIL;

    -- xóa nhóm nếu người dùng là trưởng nhóm
        DELETE FROM NHOM
        WHERE EMAIL_TRUONGNHOM = I_EMAIL;

    -- xóa người dùng
        DELETE FROM NGUOIDUNG
        WHERE EMAILND = I_EMAIL;

        DBMS_OUTPUT.PUT_LINE('Xóa ng??i dùng thành công');
    END IF;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Người dùng không tồn tại');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Có lỗi xảy ra trong quá trình xóa người dùng');
END;
/

set serveroutput on;
execute XOA_NGUOIDUNG('baonhanxyz@gmail.com');


set serveroutput on;
execute XOA_NGUOIDUNG('thuytrang004@gmail.com');


-------------------------------------------------------------------------------------------------------------
-- THEM CONG VIEC
create or replace PROCEDURE THEM_CONGVIEC (
    I_MANHOM NHOM.MANHOM%TYPE,
    I_TENCV CONGVIEC.TENCV%TYPE,
    I_LINHVUC CONGVIEC.LINHVUC%TYPE,
    I_MOTACV CONGVIEC.MOTACV%TYPE,
    I_MUC_UUTIEN CONGVIEC.MUC_UUTIEN%TYPE,
    I_NGAYBD CONGVIEC.NGAYBD%TYPE,
    I_NGAYKT CONGVIEC.NGAYKT%TYPE,
    p_message OUT VARCHAR2
)
IS
    I_MACV CONGVIEC.MACV%TYPE;
    V_COUNT NUMBER;
BEGIN

    SELECT COUNT(*) INTO V_COUNT
    FROM CONGVIEC
    WHERE MACV = I_MACV;
    
    IF V_COUNT > 0 THEN
        p_message := 'Công vi?c ?ã t?n t?i.';
    ELSE
        -- Generate a new group ID
        SELECT NVL(MAX(MACV), 0) + 1 INTO I_MACV
        FROM CONGVIEC;
    
        INSERT INTO CONGVIEC VALUES (I_MACV, I_MANHOM, I_TENCV, I_LINHVUC, I_MOTACV, I_MUC_UUTIEN, I_NGAYBD, I_NGAYKT);
        p_message := 'Them cong viec thanh cong.';
    END IF;
END;

-----------------------------------------------------------------------------------------
--THEM THUC HIEN
CREATE OR REPLACE PROCEDURE THEM_THUCHIEN(
    I_EMAILTV THUCHIEN.EMAIL_TV%TYPE,
    I_MACV_PC THUCHIEN.MACV_PC%TYPE,
    I_MANHOM THUCHIEN.MANHOM%TYPE,
    I_TRANGTHAI THUCHIEN.TRANGTHAI%TYPE
    )
IS
BEGIN
    INSERT INTO THUCHIEN (EMAIL_TV, MACV_PC, MANHOM, TRANGTHAI) 
    VALUES (I_EMAILTV, I_MACV_PC, I_MANHOM, I_TRANGTHAI);
    DBMS_OUTPUT.PUT_LINE('Them thuc hien thanh cong');
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('Da ton tai');
END;

--------------------------------------------------------------------------------
set serveroutput on;
execute THEM_CONGVIEC('7', '2', 'ĐỒ ÁN CNTT', 'CNTT', 'BÁO CÁO', '1', '30-MAY-24', '31-MAY-24');
DECLARE
  v_message VARCHAR2(200);
BEGIN
  pc_themtvvaonhom('22521455@gm.uit.edu.vn', '4', v_message);
  DBMS_OUTPUT.PUT_LINE(v_message);
END;
/

-----------------------------------------------------------------------------------------------------------------
--CAP NHAT CONG VIEC
CREATE OR REPLACE PROCEDURE CAPNHAT_CONGVIEC (
    p_MACV  CONGVIEC.MACV%TYPE,
    p_TENCV CONGVIEC.TENCV%TYPE,
    p_LINHVUC CONGVIEC.LINHVUC%TYPE,
    p_MOTA CONGVIEC.MOTACV%TYPE,
    p_MDUT CONGVIEC.MUC_UUTIEN%TYPE,
    p_NGAYBD CONGVIEC.NGAYBD%TYPE,
    p_DEADLINE CONGVIEC.NGAYKT%TYPE
)
IS
    L_MACV CONGVIEC.MACV%TYPE; 
BEGIN
    SELECT MACV INTO L_MACV
    FROM CONGVIEC
    WHERE MACV = P_MACV;
    
    IF L_MACV IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('MACV không t?n t?i');
    ELSE
        UPDATE CONGVIEC
        SET TENCV = p_TENCV,
            MUC_UUTIEN = p_MDUT,
            MOTACV = p_MOTA,
            LINHVUC = p_LINHVUC,
            NGAYBD = p_NGAYBD,
            NGAYKT = p_DEADLINE
        WHERE MACV = p_MACV;
        DBMS_OUTPUT.PUT_LINE('Cập nhật công việc thành công');
        
    END IF;
    EXCEPTION WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Cong viec khong ton tai');
END;
/

set serveroutput on;
execute CAPNHAT_CONGVIEC('7', 'Tạo giao diện ', 'CNTT', 'java Swing', 1, '20-MAY-24', '22-MAY-24');

------------------------------------------------------------------------------------------------------
--CAP NHAT TRANG  THAI CONG VIEC
create or replace PROCEDURE CAPNHAT_TRANGTHAI_CONGVIEC (
    P_MACV_PC THUCHIEN.MACV_PC%TYPE,
    P_TRANGTHAI THUCHIEN.TRANGTHAI%TYPE
)
IS 
    L_MACV VARCHAR2(30);
BEGIN
    SELECT MACV_PC INTO L_MACV
    FROM THUCHIEN
    WHERE MACV_PC = P_MACV_PC;
    IF L_MACV IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('Cong viec khong ton tai');
    ELSE
        UPDATE THUCHIEN
        SET TRANGTHAI = P_TRANGTHAI
        WHERE MACV_PC = P_MACV_PC;
        DBMS_OUTPUT.PUT_LINE('Cap nhat trang thai thanh cong');
    END IF;
    EXCEPTION WHEN NO_DATA_FOUND THEN
    DBMS_OUTPUT.PUT_LINE('Cong viec khong ton tai');
END;
/
set serveroutput on;
execute CAPNHAT_TRANGTHAI_CONGVIEC(1, 'Đã làm')

------------------------------------------------------------------------------------------------------
-- XEM CONG VIEC CO TRANG THAI DA LAM
create or replace PROCEDURE XEM_CONGVIEC_DA_LAM 
IS
BEGIN
    FOR cv_danglam IN (SELECT nh.TENNHOM, cv.TENCV, cv.LINHVUC, cv.MOTACV, cv.NGAYBD, cv.NGAYKT, cv.MUC_UUTIEN
                        FROM CONGVIEC cv
                        JOIN NHOM nh ON cv.MANHOM = nh.MANHOM
                        JOIN THUCHIEN th ON cv.MACV = th.MACV_PC AND cv.MANHOM = th.MANHOM
                        WHERE th.TRANGTHAI = '?ã làm') 
    LOOP
        -- Xu ly in ra muc do uu tiên
        DECLARE 
            muc_uutien_str VARCHAR2(20);
        BEGIN
            IF cv_danglam.MUC_UUTIEN = 1 THEN
                muc_uutien_str := 'C?n g?p';
            ELSIF cv_danglam.MUC_UUTIEN = 2 THEN
                muc_uutien_str := 'Quan tr?ng';
            ELSE
                muc_uutien_str := 'Th??ng';
            END IF;
            
            -- In ra thong tin cv 
            DBMS_OUTPUT.PUT_LINE('Tên nhóm: ' || cv_danglam.TENNHOM);
            DBMS_OUTPUT.PUT_LINE('Tên công vi?c: ' || cv_danglam.TENCV);
            DBMS_OUTPUT.PUT_LINE('L?nh v?c: ' || cv_danglam.LINHVUC);
            DBMS_OUTPUT.PUT_LINE('Mô t?: ' || cv_danglam.MOTACV);
            DBMS_OUTPUT.PUT_LINE('Ngày b?t ??u: ' || TO_CHAR(cv_danglam.NGAYBD, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('Ngày k?t thúc: ' || TO_CHAR(cv_danglam.NGAYKT, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('M?c ?? ?u tiên: ' || muc_uutien_str);
            DBMS_OUTPUT.PUT_LINE('-------------------------');
        END;
    END LOOP;
END;

set serveroutput on;
execute  XEM_CONGVIEC_DA_LAM; 

---------------------------------------------------------------------------------------------
-- XEM CONG VIEC CO TRANG THAI DANG LAM
CREATE OR REPLACE PROCEDURE pc_xemcvdanglam IS
BEGIN
    FOR cv_danglam IN (SELECT nh.TENNHOM, cv.TENCV, cv.LINHVUC, cv.MOTACV, cv.NGAYBD, cv.NGAYKT, cv.MUC_UUTIEN
                        FROM CONGVIEC cv
                        JOIN NHOM nh ON cv.MANHOM = nh.MANHOM
                        JOIN THUCHIEN th ON cv.MACV = th.MACV_PC AND cv.MANHOM = th.MANHOM
                        WHERE th.TRANGTHAI = 'Đang làm') 
    LOOP
        -- Xu ly in ra muc do uu tiên
        DECLARE 
            muc_uutien_str VARCHAR2(20);
        BEGIN
            IF cv_danglam.MUC_UUTIEN = 1 THEN
                muc_uutien_str := 'Cần gấp';
            ELSIF cv_danglam.MUC_UUTIEN = 2 THEN
                muc_uutien_str := 'Quan trọng';
            ELSE
                muc_uutien_str := 'Thường';
            END IF;
            
            -- In ra thong tin cv 
            DBMS_OUTPUT.PUT_LINE('Tên nhóm: ' || cv_danglam.TENNHOM);
            DBMS_OUTPUT.PUT_LINE('Tên công vi?c: ' || cv_danglam.TENCV);
            DBMS_OUTPUT.PUT_LINE('L?nh v?c: ' || cv_danglam.LINHVUC);
            DBMS_OUTPUT.PUT_LINE('Mô tả ' || cv_danglam.MOTACV);
            DBMS_OUTPUT.PUT_LINE('Ngày bắt đầu: ' || TO_CHAR(cv_danglam.NGAYBD, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('Ngày kết thúc: ' || TO_CHAR(cv_danglam.NGAYKT, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('Mức độ ưu tiên: ' || muc_uutien_str);
            DBMS_OUTPUT.PUT_LINE('-------------------------');
        END;
    END LOOP;
END;
/
set serveroutput on;
execute pc_xemcvdanglam;

----------------------------------------------------------------------------------
--Xem cong viec can lam
CREATE OR REPLACE PROCEDURE pc_xemcvcanlam IS
BEGIN
    FOR cv_selam IN (SELECT nh.TENNHOM, cv.TENCV, cv.LINHVUC, cv.MOTACV, cv.NGAYBD, cv.NGAYKT, cv.MUC_UUTIEN
                        FROM CONGVIEC cv
                        JOIN NHOM nh ON cv.MANHOM = nh.MANHOM
                        JOIN THUCHIEN th ON cv.MACV = th.MACV_PC AND cv.MANHOM = th.MANHOM
                        WHERE th.TRANGTHAI = 'Cần làm') 
    LOOP
        -- X? lý in ra m?c ?? ?u tiên
        DECLARE muc_uutien_str VARCHAR2(20);
        BEGIN
            IF cv_selam.MUC_UUTIEN = 1 THEN
                muc_uutien_str := 'Cần gấp';
            ELSIF cv_selam.MUC_UUTIEN = 2 THEN
                muc_uutien_str := 'Quan trọng';
            ELSE
                muc_uutien_str := 'Thường';
            END IF;
            
            -- In ra thông tin công viec
            DBMS_OUTPUT.PUT_LINE('Ten nhom: ' || cv_selam.TENNHOM);
            DBMS_OUTPUT.PUT_LINE('Ten cong viec: ' || cv_selam.TENCV);
            DBMS_OUTPUT.PUT_LINE('Linh vuc: ' || cv_selam.LINHVUC);
            DBMS_OUTPUT.PUT_LINE('Mo ta: ' || cv_selam.MOTACV);
            DBMS_OUTPUT.PUT_LINE('Ngay bat dau: ' || TO_CHAR(cv_selam.NGAYBD, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('Ngay ket thuc: ' || TO_CHAR(cv_selam.NGAYKT, 'DD-MON-YY'));
            DBMS_OUTPUT.PUT_LINE('Muc do uu tien: ' || muc_uutien_str);
            DBMS_OUTPUT.PUT_LINE('-------------------------');
        END;
    END LOOP;
END;
/
set serveroutput on;
execute pc_xemcvcanlam;
------------------------------------------------------------------------------
-- KIEM TRA CV HET HAN
CREATE OR REPLACE PROCEDURE pc_ktcv (
    p_macv_pc IN THUCHIEN.MACV_PC%TYPE
)
IS
    v_ngaykt DATE;
    v_message VARCHAR2(50);
BEGIN
    -- Lay ngay KT cua CV tai bang THUCHIEN
    SELECT cv.NGAYKT
    INTO v_ngaykt
    FROM CONGVIEC cv
    JOIN THUCHIEN th ON cv.MACV = th.MACV_PC
    WHERE th.MACV_PC = p_macv_pc;
    
    -- So sánh ngày ket thúc voi ngày hien tai
    IF v_ngaykt < SYSDATE THEN
        v_message := 'Cong viec da qua han nop';
    ELSIF v_ngaykt = TRUNC(SYSDATE) THEN
        v_message := 'Cong viec den han nop';
    ELSE
        v_message := 'Cong viec chua den han nop';
    END IF;
    
    -- In ra thong bao
    DBMS_OUTPUT.PUT_LINE(v_message);
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Khong tim thay cong viec voi ma: ' || p_macv_pc);
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Loi xay ra: ' || SQLERRM);
END pc_ktcv;
/
SET SERVEROUTPUT ON;
EXECUTE pc_ktcv('1');

--THEM THANH VIEN VAO NHOM
CREATE OR REPLACE PROCEDURE pc_themtvvaonhom(
    p_emailnd NGUOIDUNG.EMAILND%TYPE,
    p_manhom NHOM.MANHOM%TYPE,
    p_message OUT VARCHAR2
) AS
    v_count NUMBER;
BEGIN
    -- Kt thanh vien va ma nhom co ton tai trong bang NGUOIDUNG va NHOM ko
    SELECT COUNT(*)
    INTO v_count
    FROM NGUOIDUNG
    WHERE EMAILND = p_emailnd;

    IF v_count = 0 THEN
        p_message := 'Them khong thanh cong. Email khong ton tai.';
        RETURN;
    END IF;

    SELECT COUNT(*)
    INTO v_count
    FROM NHOM
    WHERE MANHOM = p_manhom;

    IF v_count = 0 THEN
        p_message := 'Them thanh vien khong thanh cong. Ma nhom khong ton tai.';
        RETURN;
    END IF;

    -- Kt tv da ton tai trong nhom chua
    SELECT COUNT(*)
    INTO v_count
    FROM NGUOIDUNG_NHOM
    WHERE EMAILND = p_emailnd AND MANHOM = p_manhom;

    IF v_count > 0 THEN
        p_message := 'Them khong thanh cong. Thanh vien da ton tai trong nhom.';
        RETURN;
    END IF;

    -- Them thanh vien vao nhom
    INSERT INTO NGUOIDUNG_NHOM (EMAILND, MANHOM)
    VALUES (p_emailnd, p_manhom);

    p_message := 'Them thanh vien vao nhom thanh cong.';
EXCEPTION
    WHEN OTHERS THEN
        p_message := 'Them thanh vien khong thanh cong. Loi: ' || SQLERRM;
END;
/
 SET SERVEROUTPUT ON;
DECLARE
  v_message VARCHAR2(200);
BEGIN
  pc_themtvvaonhom('22521455@gm.uit.edu.vn', '4', v_message);
  DBMS_OUTPUT.PUT_LINE(v_message);
END;
/
-------------------------------------------------------------------------------
-- XOA THANH VIEN KHOI NHOM
CREATE OR REPLACE PROCEDURE pc_xoatvvkhoinhom (
    p_email VARCHAR2,
    p_manhom VARCHAR2,
    p_message OUT VARCHAR2
) AS
    v_count NUMBER;
BEGIN
    -- Kt xem thanh vien co trong nhom khong
    SELECT COUNT(*)
    INTO v_count
    FROM NGUOIDUNG_NHOM
    WHERE EMAILND = p_email AND MANHOM = p_manhom;

    IF v_count = 0 THEN
        p_message := 'Thanh vien khong ton tai trong nhom.';
    ELSE
        -- Xoa thanh vien khoi nhom
        DELETE FROM NGUOIDUNG_NHOM
        WHERE EMAILND = p_email AND MANHOM = p_manhom;

        --xoa thong tin phan cong cua thanh vien
        DELETE FROM THUCHIEN
        WHERE EMAIL_TV = p_email AND MANHOM = p_manhom;

        p_message := 'Xoa thanh vien khoi nhom thanh cong.';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        p_message := 'Da xay ra loi ' || SQLERRM;
END;
/
DECLARE
    v_message VARCHAR2(200);
BEGIN
    pc_xoatvvkhoinhom('example@email.com', '1', v_message);
    DBMS_OUTPUT.PUT_LINE(v_message);
END;
/

--------------------------------------------------------------------------
--XOANHOM
CREATE OR REPLACE PROCEDURE XOANHOM (
    P_MANHOM VARCHAR2,
    p_message OUT VARCHAR2
) AS
    v_count NUMBER;
BEGIN
    -- KT XEM NHOM CO TON TAI KHONG
    SELECT COUNT(*) INTO v_count
    FROM NHOM
    WHERE MANHOM = P_MANHOM;

    IF v_count = 0 THEN
        p_message := 'NHOM KHONG TON T?I.';
    ELSE
         -- Xoa thanh vien khoi nhom
        DELETE FROM NGUOIDUNG_NHOM
        WHERE MANHOM = P_MANHOM;

        --xoa thong tin phan cong nhom
        DELETE FROM THUCHIEN
        WHERE MANHOM = P_MANHOM;

        --XOA NHOM
        DELETE FROM NHOM
        WHERE MANHOM = P_MANHOM;

        p_message := 'Xoa nhom thanh cong.';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        p_message := 'Da xay ra loi ' || SQLERRM;
END;
/


set serveroutput on;
DECLARE
    v_message VARCHAR2(200);
BEGIN
    XOANHOM('3', v_message);
    DBMS_OUTPUT.PUT_LINE(v_message);
END;
/


DECLARE
    v_message VARCHAR2(200);
BEGIN
    pc_xoatvvkhoinhom('example@email.com', '1', v_message);
    DBMS_OUTPUT.PUT_LINE(v_message);
END;
/


-- T?O NHÓM
CREATE OR REPLACE PROCEDURE TAONHOM (
    I_TENNHOM NHOM.TENNHOM%TYPE,
    I_EMAIL_TN NHOM.EMAIL_TRUONGNHOM%TYPE,
    p_message OUT VARCHAR2
)
IS
    I_MANHOM NHOM.MANHOM%TYPE;
    V_COUNT NUMBER;
BEGIN
    -- Kiểm tra xem tên nhóm đã tồn tại chưa
    SELECT COUNT(*) INTO V_COUNT
    FROM NHOM
    WHERE TENNHOM = I_TENNHOM;
    
    -- Nếu tồn tại, thông báo lỗi và thoát procedure
    IF V_COUNT > 0 THEN
        p_message := 'Tên nhóm đã tồn tại.';
    ELSE
        -- Thêm m?i nhóm n?u ch?a t?n t?i
        SELECT NVL(MAX(MANHOM), 0) + 1 INTO I_MANHOM FROM NHOM;
        
        INSERT INTO NHOM (MANHOM, TENNHOM, EMAIL_TRUONGNHOM) 
        VALUES (I_MANHOM, I_TENNHOM, I_EMAIL_TN);
        
        p_message := 'Thêm nhóm thành công.';
    END IF;
END;

DECLARE
    v_message VARCHAR2(100);
BEGIN
    TAONHOM('hihihi', '22521366@gm.uit.edu.vn', v_message);
    DBMS_OUTPUT.PUT_LINE(v_message);
END;

DECLARE
    I_MANHOM NUMBER;
BEGIN
    SELECT NVL(MAX(MANHOM), 0) + 1 INTO I_MANHOM FROM NHOM;
    -- Use I_MANHOM variable here
    DBMS_OUTPUT.PUT_LINE('Next MANHOM value: ' || I_MANHOM);
END;

-----------------------------------------------------------------------
--Tạo folder chứa file
CREATE DIRECTORY FileAttachments AS 'c:/FileAttachments';
--Cấp quyền
GRANT READ, WRITE ON DIRECTORY FileAttachments TO PUBLIC;
--Tạo lớp java
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "FileUtils" AS
import java.io.File;

public class FileUtils {
    public static long getFileSize(String filePath) {
        File file = new File(filePath);
        return file.length();
    }
}
/
--Tạo function lấy kích thước file
CREATE OR REPLACE FUNCTION GET_FILE_SIZE(P_FILE_PATH IN VARCHAR2) RETURN NUMBER AS
LANGUAGE JAVA NAME 'FileUtils.getFileSize(java.lang.String) return long';
/
--THÊM FILE
create or replace PROCEDURE INSERT_FILE_ATTACHMENT (
    P_DUONGDAN IN FILE_ATTACHMENT.DUONGDAN%TYPE,
    P_MACV IN FILE_ATTACHMENT.MA_CV%TYPE
) AS
    I_TENFILE VARCHAR2(255);
    I_LOAIFILE VARCHAR2(100) := 'application/octet-stream';
    I_KICHTHUOC NUMBER;
BEGIN
    -- Lấy thông tin từ file về đường đẫn
    I_TENFILE := SUBSTR(P_DUONGDAN, INSTR(P_DUONGDAN, '/', -1) + 1);

    -- Lấy kích thước của tệp tùe Java Stored Function
    I_KICHTHUOC := GET_FILE_SIZE(P_DUONGDAN);

    -- Chèn bản ghi vào bảng FILE_ATTACHMENT
    INSERT INTO FILE_ATTACHMENT (
        MAFILE,
        TENFILE,
        LOAIFILE,
        KICHTHUOC,
        DUONGDAN,
        MA_CV
    ) VALUES (
        NULL, -- MAFILE sẽ được tạo tự động
        I_TENFILE,
        I_LOAIFILE,
        I_KICHTHUOC,
        P_DUONGDAN,
        P_MACV
    );
    COMMIT;
END INSERT_FILE_ATTACHMENT;

--procedure cấp quyền truy cập file
CREATE OR REPLACE PROCEDURE GRANT_FILE_PERMISSION (
    p_file_path   IN VARCHAR2
) AS
BEGIN
    DBMS_JAVA.GRANT_PERMISSION(
        'C##TICTAC',
        'SYS:java.io.FilePermission',
        p_file_path, //Các đường dẫn của file
        'read'
    );
END GRANT_FILE_PERMISSION;
/


set serveroutput on;
execute INSERT_FILE_ATTACHMENT('C:\Users\Oracle\Documents\b4.txt', '3');


----------------------------------------------------------------------
----------------------------------------------------------------------
-------------------------FUNCTION--------------------------------------
-- THONG KE SL CONG VIEC CO TRANG THAI DA HOAN THANH
CREATE OR REPLACE FUNCTION fc_slcvdahoanthanh(
    p_manhom IN VARCHAR2
) RETURN NUMBER
IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM THUCHIEN
    WHERE MANHOM = p_manhom
    AND TRANGTHAI = 'Đã hoàn thành';

    RETURN v_count;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END;
/
DECLARE
    v_count NUMBER;
BEGIN
    v_count := fc_slcvdahoanthanh(1);
    DBMS_OUTPUT.PUT_LINE('SL cong viecc da hoan thanh: ' || v_count);
END;
/
----------------------------------------------------------------------------
-- THONG KE SL CONG VIEC CO TRANG THAI DANG LAM
CREATE OR REPLACE FUNCTION fc_slcvdanglam(
    p_manhom IN VARCHAR2
) RETURN NUMBER IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM THUCHIEN
    WHERE MANHOM = p_manhom AND TRANGTHAI = 'Đang làm';

    RETURN v_count;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END fc_slcvdanglam;
/

set serveroutput on;
DECLARE
    v_count NUMBER;
BEGIN
    v_count := fc_slcvdanglam(2);
    DBMS_OUTPUT.PUT_LINE('SL cong viec dang lam: ' || v_count);
END;
/
--THONG KE SL CONG VIEC CAN LAM -------------------------------------------
CREATE OR REPLACE FUNCTION fc_slcvcanlam(
    p_manhom IN VARCHAR2
) RETURN NUMBER IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM THUCHIEN
    WHERE MANHOM = p_manhom AND TRANGTHAI = 'Cần làm';

    RETURN v_count;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END fc_slcvcanlam;
/

set serveroutput on;

DECLARE
    v_slcv NUMBER;
BEGIN
    v_slcv := fc_slcvcanlam(1);

    DBMS_OUTPUT.PUT_LINE('SL cong viec can lam: ' || v_slcv);
END;
/


